<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastrear Pedido</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .info-bar {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .info-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .info-item .icon {
            font-size: 20px;
        }

        .info-item .label {
            color: #666;
            font-weight: 500;
        }

        .info-item .value {
            color: #333;
            font-weight: 600;
        }

        #map { 
            height: calc(100vh - 200px);
            width: 100%;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.waiting {
            background: #ff9800;
            color: white;
        }

        .alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2196F3;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            animation: slideUp 0.3s ease;
            max-width: 90%;
            text-align: center;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .alert.show {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="connection-status waiting" id="connectionStatus">
        üü° Aguardando motorista...
    </div>

    <div class="header">
        <h1>üì¶ Rastreamento do Pedido</h1>
    </div>

    <div class="info-bar">
        <div class="info-item">
            <span class="icon">‚è±Ô∏è</span>
            <span class="label">Tempo estimado:</span>
            <span class="value" id="tempoEntrega">Calculando...</span>
        </div>
        <div class="info-item">
            <span class="icon">üìç</span>
            <span class="label">Dist√¢ncia:</span>
            <span class="value" id="distancia">-</span>
        </div>
        <div class="info-item">
            <span class="icon">üöó</span>
            <span class="label">Status:</span>
            <span class="value" id="statusMotorista">Aguardando motorista...</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p style="margin: 0; color: #333; font-weight: 600;">Calculando rota...</p>
        </div>
    </div>

    <div class="alert" id="alert"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ==================== CONFIGURA√á√ÉO ====================
        console.log('üì¶ Iniciando rastreamento do pedido...');

        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 10,
            timeout: 10000
        });

        const apiKey = '5b3ce3597851110001cf6248461ce4f521b24420bbc67527fa68a8ab';

        // ==================== ELEMENTOS DOM ====================
        const connectionStatus = document.getElementById('connectionStatus');
        const alertDiv = document.getElementById('alert');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // ==================== OBTER COORDENADAS DO DESTINO ====================
        let coordenadasDestino = null;

        try {
            coordenadasDestino = JSON.parse(sessionStorage.getItem('coordenadasDestino'));
            console.log('üìç Coordenadas do destino:', coordenadasDestino);
            
            if (!coordenadasDestino || !coordenadasDestino.lat || !coordenadasDestino.lon) {
                throw new Error('Coordenadas inv√°lidas');
            }
        } catch (error) {
            console.error('‚ùå Erro ao obter coordenadas:', error);
            alert('Erro: Coordenadas de destino n√£o encontradas. Redirecionando...');
            window.location.href = '/endereco.html';
        }

        // ==================== INICIALIZAR MAPA ====================
        const map = L.map('map').setView([coordenadasDestino.lat, coordenadasDestino.lon], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // ==================== √çCONES ====================
        const destinoIcon = L.icon({
            iconUrl: 'casa.png',
            iconSize: [45, 45],
            iconAnchor: [22, 45],
            popupAnchor: [0, -45]
        });

        const motoristaIcon = L.icon({
            iconUrl: 'wN5QD.png',
            iconSize: [50, 50],
            iconAnchor: [25, 25],
            popupAnchor: [0, -25]
        });

        // Fallback se imagens n√£o existirem
        const destinoIconFallback = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const motoristaIconFallback = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // ==================== MARCAR DESTINO ====================
        let marcadorDestino = null;
        try {
            marcadorDestino = L.marker([coordenadasDestino.lat, coordenadasDestino.lon], { icon: destinoIcon })
                .addTo(map)
                .bindPopup('üè† Endere√ßo de Entrega')
                .openPopup();
        } catch (error) {
            console.warn('‚ö†Ô∏è Usando √≠cone fallback para destino');
            marcadorDestino = L.marker([coordenadasDestino.lat, coordenadasDestino.lon], { icon: destinoIconFallback })
                .addTo(map)
                .bindPopup('üè† Endere√ßo de Entrega')
                .openPopup();
        }

        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let coordenadasMotorista = null;
        let marcadorMotorista = null;
        let rota = null;
        let ultimaPosicao = null;
        let ultimaRotaCalculada = null;
        let animacaoAtiva = null;
        let totalAtualizacoes = 0;

        // ==================== FUN√á√ïES AUXILIARES ====================
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        function formatarTempo(tempoMinutos) {
            const horas = Math.floor(tempoMinutos / 60);
            const minutos = Math.round(tempoMinutos % 60);
            if (horas > 0) {
                return `${horas}h ${minutos}min`;
            }
            return `${minutos} min`;
        }

        function calcularAngulo(lat1, lon1, lat2, lon2) {
            const rad = Math.PI / 180;
            const dLon = (lon2 - lon1) * rad;
            const y = Math.sin(dLon) * Math.cos(lat2 * rad);
            const x = Math.cos(lat1 * rad) * Math.sin(lat2 * rad) -
                      Math.sin(lat1 * rad) * Math.cos(lat2 * rad) * Math.cos(dLon);
            let ang = Math.atan2(y, x);
            return (ang * 180 / Math.PI + 360) % 360;
        }

        function mostrarAlerta(mensagem, duracao = 3000) {
            alertDiv.textContent = mensagem;
            alertDiv.classList.add('show');
            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, duracao);
        }

        // ==================== INTERPOLA√á√ÉO SUAVE ====================
        function interpolarPosicao(inicio, fim, duracao = 1500) {
            if (animacaoAtiva) clearInterval(animacaoAtiva);

            const passos = 30;
            const intervalo = duracao / passos;
            let passo = 0;

            animacaoAtiva = setInterval(() => {
                passo++;
                const progresso = passo / passos;
                
                const latAtual = inicio.lat + (fim.lat - inicio.lat) * progresso;
                const lonAtual = inicio.lon + (fim.lon - inicio.lon) * progresso;

                if (marcadorMotorista) {
                    marcadorMotorista.setLatLng([latAtual, lonAtual]);
                }

                if (passo >= passos) {
                    clearInterval(animacaoAtiva);
                    animacaoAtiva = null;
                }
            }, intervalo);
        }

        // ==================== CALCULAR ROTA ====================
        async function calcularRotaETempo(latInicio, lonInicio, latFim, lonFim) {
            // Throttling: s√≥ recalcular se moveu mais de 50 metros
            if (ultimaRotaCalculada) {
                const distancia = calcularDistancia(
                    ultimaRotaCalculada.lat, 
                    ultimaRotaCalculada.lon,
                    latInicio, 
                    lonInicio
                );
                if (distancia < 50) {
                    console.log('‚ÑπÔ∏è Movimento < 50m, n√£o recalculando rota');
                    return;
                }
            }

            try {
                loadingOverlay.classList.add('show');
                console.log(`üó∫Ô∏è Calculando rota de [${latInicio}, ${lonInicio}] para [${latFim}, ${lonFim}]`);

                const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${lonInicio},${latInicio}&end=${lonFim},${latFim}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();

                if (!data.features || data.features.length === 0) {
                    throw new Error('Nenhuma rota encontrada');
                }

                const coordenadasRota = data.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                const duracaoMinutos = data.features[0].properties.segments[0].duration / 60;
                const distanciaKm = (data.features[0].properties.segments[0].distance / 1000).toFixed(1);

                console.log(`‚úÖ Rota calculada: ${distanciaKm}km, ${formatarTempo(duracaoMinutos)}`);

                document.getElementById('tempoEntrega').innerText = formatarTempo(duracaoMinutos);
                document.getElementById('distancia').innerText = `${distanciaKm} km`;

                if (rota) {
                    rota.setLatLngs(coordenadasRota);
                } else {
                    rota = L.polyline(coordenadasRota, { 
                        color: '#2196F3', 
                        weight: 5, 
                        opacity: 0.7 
                    }).addTo(map);
                }

                // Ajustar zoom para mostrar toda a rota
                const bounds = L.latLngBounds([
                    [latInicio, lonInicio],
                    [latFim, lonFim]
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });

                ultimaRotaCalculada = { lat: latInicio, lon: lonInicio };
                loadingOverlay.classList.remove('show');

            } catch (error) {
                console.error('‚ùå Erro ao calcular rota:', error);
                loadingOverlay.classList.remove('show');
                mostrarAlerta('‚ö†Ô∏è Erro ao calcular rota. Tentando novamente...', 3000);
                
                // Retry ap√≥s 5 segundos
                setTimeout(() => {
                    calcularRotaETempo(latInicio, lonInicio, latFim, lonFim);
                }, 5000);
            }
        }

        // ==================== SOCKET.IO ====================
        socket.on('connect', () => {
            console.log('‚úÖ Conectado ao servidor! Socket ID:', socket.id);
            connectionStatus.textContent = 'üü¢ Conectado';
            connectionStatus.className = 'connection-status connected';
            mostrarAlerta('‚úÖ Conectado ao servidor');
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Desconectado do servidor');
            connectionStatus.textContent = 'üî¥ Desconectado';
            connectionStatus.className = 'connection-status disconnected';
            document.getElementById('statusMotorista').textContent = 'Desconectado do servidor';
            mostrarAlerta('‚ùå Conex√£o perdida. Reconectando...');
        });

        socket.on('connect_error', (error) => {
            console.error('‚ùå Erro de conex√£o:', error);
            mostrarAlerta('‚ö†Ô∏è Erro de conex√£o');
        });

        // ==================== ATUALIZA√á√ÉO DO MOTORISTA ====================
        socket.on('atualizacaoLocalizacao', (data) => {
            totalAtualizacoes++;
            console.log(`üìç [#${totalAtualizacoes}] Atualiza√ß√£o do motorista:`, data);

            const novaPosicao = { lat: data.lat, lon: data.lon };

            // Atualizar status
            connectionStatus.textContent = 'üü¢ Rastreando';
            connectionStatus.className = 'connection-status connected';
            document.getElementById('statusMotorista').textContent = 'Motorista a caminho';

            if (marcadorMotorista) {
                // Interpolar movimento suave
                const posicaoAtual = marcadorMotorista.getLatLng();
                interpolarPosicao(
                    { lat: posicaoAtual.lat, lon: posicaoAtual.lng },
                    novaPosicao,
                    1500
                );

                // Calcular e aplicar rota√ß√£o
                if (ultimaPosicao) {
                    const angulo = calcularAngulo(
                        ultimaPosicao.lat, ultimaPosicao.lon,
                        novaPosicao.lat, novaPosicao.lon
                    );
                    
                    if (marcadorMotorista.setRotationAngle) {
                        marcadorMotorista.setRotationAngle(angulo);
                    }
                }
            } else {
                // Criar marcador do motorista
                console.log('üöó Criando marcador do motorista');
                try {
                    marcadorMotorista = L.marker(
                        [novaPosicao.lat, novaPosicao.lon],
                        { 
                            icon: motoristaIcon, 
                            rotationAngle: 0, 
                            rotationOrigin: "center" 
                        }
                    ).addTo(map)
                    .bindPopup('üöó Motorista')
                    .openPopup();
                } catch (error) {
                    console.warn('‚ö†Ô∏è Usando √≠cone fallback para motorista');
                    marcadorMotorista = L.marker(
                        [novaPosicao.lat, novaPosicao.lon],
                        { icon: motoristaIconFallback }
                    ).addTo(map)
                    .bindPopup('üöó Motorista')
                    .openPopup();
                }

                mostrarAlerta('üöó Motorista localizado!', 3000);
            }

            ultimaPosicao = { ...novaPosicao };
            coordenadasMotorista = novaPosicao;

            // Recalcular rota (com throttling interno)
            calcularRotaETempo(
                novaPosicao.lat, 
                novaPosicao.lon, 
                coordenadasDestino.lat, 
                coordenadasDestino.lon
            );
        });

        // ==================== INICIALIZA√á√ÉO ====================
        console.log('‚úÖ Rastreamento iniciado');
        console.log('üìç Aguardando localiza√ß√£o do motorista...');
        
        // Timeout: se n√£o receber atualiza√ß√£o em 30 segundos
        setTimeout(() => {
            if (!coordenadasMotorista) {
                console.warn('‚ö†Ô∏è Nenhuma atualiza√ß√£o do motorista em 30 segundos');
                mostrarAlerta('‚ö†Ô∏è Aguardando motorista iniciar entrega...', 5000);
            }
        }, 30000);
    </script>
</body>
</html>
