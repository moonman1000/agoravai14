<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rastrear Pedido</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    *{box-sizing:border-box} body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;background:#f5f5f5}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;text-align:center}
    .info-bar{background:#fff;padding:15px 20px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .info-item{margin:8px 0;display:flex;align-items:center;gap:10px;font-size:15px}
    #map{height:calc(100vh - 200px);width:100%}
    .connection-status{position:fixed;top:10px;right:10px;padding:8px 15px;border-radius:20px;font-size:12px;font-weight:600;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .connection-status.connected{background:#4caf50;color:#fff}
    .connection-status.disconnected{background:#f44336;color:#fff}
    .connection-status.waiting{background:#ff9800;color:#fff}
    .alert{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#2196F3;color:#fff;padding:15px 25px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:9999;display:none;max-width:90%;text-align:center}
    .alert.show{display:block}
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10000}
    .loading-overlay.show{display:flex}
    .loading-content{background:#fff;padding:30px;border-radius:15px;text-align:center}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="connection-status waiting" id="connectionStatus">üü° Aguardando motorista...</div>
  <div class="header"><h1>üì¶ Rastreamento do Pedido</h1></div>
  <div class="info-bar">
    <div class="info-item"><span>‚è±Ô∏è</span><span>Tempo estimado:</span> <strong id="tempoEntrega">Calculando...</strong></div>
    <div class="info-item"><span>üìç</span><span>Dist√¢ncia:</span> <strong id="distancia">-</strong></div>
    <div class="info-item"><span>üöó</span><span>Status:</span> <strong id="statusMotorista">Aguardando motorista...</strong></div>
  </div>
  <div id="map"></div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content"><div class="spinner"></div><p style="margin:0">Calculando rota...</p></div>
  </div>
  <div class="alert" id="alert"></div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io(window.location.origin, {
      transports: ['websocket','polling'],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 10,
      timeout: 10000
    });

    const apiKey = '5b3ce3597851110001cf6248461ce4f521b24420bbc67527fa68a8ab'; // ORS (substitua pela sua)

    const connectionStatus = document.getElementById('connectionStatus');
    const alertDiv = document.getElementById('alert');
    const loadingOverlay = document.getElementById('loadingOverlay');

    function alertMsg(msg, t=3000){ alertDiv.textContent = msg; alertDiv.classList.add('show'); setTimeout(()=>alertDiv.classList.remove('show'), t); }
    function calcularDistancia(lat1, lon1, lat2, lon2){
      const R=6371e3, phi1=lat1*Math.PI/180, phi2=lat2*Math.PI/180;
      const dPhi=(lat2-lat1)*Math.PI/180, dLambda=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLambda/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function formatarTempo(min){ const h=Math.floor(min/60), m=Math.round(min%60); return h>0?`${h}h ${m}min`:`${m} min`; }
    function bearing(lat1, lon1, lat2, lon2){ const rad=Math.PI/180, dLon=(lon2-lon1)*rad; const y=Math.sin(dLon)*Math.cos(lat2*rad); const x=Math.cos(lat1*rad)*Math.sin(lat2*rad)-Math.sin(lat1*rad)*Math.cos(lat2*rad)*Math.cos(dLon); return (Math.atan2(y,x)*180/Math.PI+360)%360; }

    // Destino via sessionStorage
    let coordenadasDestino = null;
    try {
      coordenadasDestino = JSON.parse(sessionStorage.getItem('coordenadasDestino'));
      if (!coordenadasDestino?.lat || !coordenadasDestino?.lon) throw new Error('Coordenadas ausentes');
    } catch {
      alert('Coordenadas de destino n√£o encontradas. Redirecionando...');
      window.location.href = '/endereco.html';
    }

    const map = L.map('map').setView([coordenadasDestino.lat, coordenadasDestino.lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' }).addTo(map);

    // √çcones (com fallback)
    const destinoIcon = L.icon({ iconUrl:'casa.png', iconSize:[45,45], iconAnchor:[22,45], popupAnchor:[0,-45] });
    const motoristaIcon = L.icon({ iconUrl:'wN5QD.png', iconSize:[50,50], iconAnchor:[25,25], popupAnchor:[0,-25] });
    const destinoIconFallback = L.icon({ iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });
    const motoristaIconFallback = L.icon({ iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] });

    let marcadorDestino;
    try { marcadorDestino = L.marker([coordenadasDestino.lat, coordenadasDestino.lon], { icon: destinoIcon }).addTo(map).bindPopup('üè† Endere√ßo de Entrega').openPopup(); }
    catch { marcadorDestino = L.marker([coordenadasDestino.lat, coordenadasDestino.lon], { icon: destinoIconFallback }).addTo(map).bindPopup('üè† Endere√ßo de Entrega').openPopup(); }

    let coordenadasMotorista=null, marcadorMotorista=null, rota=null, ultimaPosicao=null, ultimaRotaCalculada=null, animacaoAtiva=null, totalAtualizacoes=0;

    function interpolarPosicao(inicio, fim, duracao=1500){
      if (animacaoAtiva) clearInterval(animacaoAtiva);
      const passos=30, intervalo=duracao/passos; let p=0;
      animacaoAtiva=setInterval(()=>{ p++; const prog=p/passos;
        const lat=inicio.lat+(fim.lat-inicio.lat)*prog, lon=inicio.lon+(fim.lon-inicio.lon)*prog;
        if(marcadorMotorista) marcadorMotorista.setLatLng([lat, lon]);
        if(p>=passos){ clearInterval(animacaoAtiva); animacaoAtiva=null; }
      }, intervalo);
    }

    async function calcularRotaETempoORS(latInicio, lonInicio, latFim, lonFim){
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${lonInicio},${latInicio}&end=${lonFim},${latFim}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('ORS HTTP ' + resp.status);
      const data = await resp.json();
      if (!data.features?.length) throw new Error('ORS sem rota');
      const seg = data.features[0].properties.segments[0];
      const coords = data.features[0].geometry.coordinates.map(([x,y]) => [y,x]);
      return { minutos: seg.duration/60, distanciaKm: seg.distance/1000, coords };
    }
    async function calcularRotaETempoOSRM(latInicio, lonInicio, latFim, lonFim){
      const url = `https://router.project-osrm.org/route/v1/driving/${lonInicio},${latInicio};${lonFim},${latFim}?overview=full&geometries=geojson`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('OSRM HTTP ' + resp.status);
      const data = await resp.json();
      if (!data.routes?.length) throw new Error('OSRM sem rota');
      const r = data.routes[0];
      const coords = r.geometry.coordinates.map(([x,y]) => [y,x]);
      return { minutos: r.duration/60, distanciaKm: r.distance/1000, coords };
    }

    async function calcularRotaETempo(latInicio, lonInicio, latFim, lonFim){
      if (ultimaRotaCalculada) {
        const d = calcularDistancia(ultimaRotaCalculada.lat, ultimaRotaCalculada.lon, latInicio, lonInicio);
        if (d < 50) return; // throttling
      }
      try {
        loadingOverlay.classList.add('show');
        let r;
        try { r = await calcularRotaETempoORS(latInicio, lonInicio, latFim, lonFim); }
        catch { r = await calcularRotaETempoOSRM(latInicio, lonInicio, latFim, lonFim); } // fallback

        document.getElementById('tempoEntrega').innerText = formatarTempo(r.minutos);
        document.getElementById('distancia').innerText = `${r.distanciaKm.toFixed(1)} km`;

        if (rota) rota.setLatLngs(r.coords);
        else rota = L.polyline(r.coords, { color:'#2196F3', weight:5, opacity:.7 }).addTo(map);

        map.fitBounds(L.latLngBounds([[latInicio,lonInicio],[latFim,lonFim]]), { padding:[50,50] });
        ultimaRotaCalculada = { lat: latInicio, lon: lonInicio };
      } catch (e) {
        console.error('Erro rota:', e);
        alertMsg('‚ö†Ô∏è Erro ao calcular rota. Tentando novamente...');
      } finally {
        loadingOverlay.classList.remove('show');
      }
    }

    socket.on('connect', () => { connectionStatus.textContent='üü¢ Conectado'; connectionStatus.className='connection-status connected'; alertMsg('‚úÖ Conectado'); });
    socket.on('disconnect', () => { connectionStatus.textContent='üî¥ Desconectado'; connectionStatus.className='connection-status disconnected'; document.getElementById('statusMotorista').textContent='Desconectado do servidor'; alertMsg('‚ùå Conex√£o perdida.'); });

    socket.on('atualizacaoLocalizacao', (data) => {
      totalAtualizacoes++;
      const nova = { lat: data.lat, lon: data.lon };
      connectionStatus.textContent = 'üü¢ Rastreando'; connectionStatus.className = 'connection-status connected';
      document.getElementById('statusMotorista').textContent = 'Motorista a caminho';

      if (marcadorMotorista) {
        const atual = marcadorMotorista.getLatLng();
        interpolarPosicao({ lat: atual.lat, lon: atual.lng }, nova, 1500);
        if (ultimaPosicao && marcadorMotorista.setRotationAngle) {
          const ang = bearing(ultimaPosicao.lat, ultimaPosicao.lon, nova.lat, nova.lon);
          marcadorMotorista.setRotationAngle(ang);
        }
      } else {
        try {
          marcadorMotorista = L.marker([nova.lat, nova.lon], { icon: motoristaIcon, rotationAngle:0, rotationOrigin:'center' })
            .addTo(map).bindPopup('üöó Motorista').openPopup();
        } catch {
          marcadorMotorista = L.marker([nova.lat, nova.lon], { icon: motoristaIconFallback }).addTo(map).bindPopup('üöó Motorista').openPopup();
        }
        alertMsg('üöó Motorista localizado!', 2500);
      }

      ultimaPosicao = { ...nova };
      coordenadasMotorista = nova;
      calcularRotaETempo(nova.lat, nova.lon, coordenadasDestino.lat, coordenadasDestino.lon);
    });

    // Timeout: sem atualiza√ß√£o em 30s
    setTimeout(() => {
      if (!coordenadasMotorista) alertMsg('‚ö†Ô∏è Aguardando motorista iniciar a entrega...', 5000);
    }, 30000);
  </script>
</body>
</html>
